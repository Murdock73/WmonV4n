#include <EmonLib.h>
#include <Adafruit_Sensor.h>
#include <DHT.h>


// Create an instance
EnergyMonitor emon1;

int rede = 230.0; // Italia 230V  
unsigned long timestampW; 
unsigned long timestampD; 

DHT dht(8, DHT22);

// current temperature & humidity, updated in loop()
float temp = 0.0;
float hum = 0.0;
char temp_send[5];
char hum_send[5];

const long intervalDHT = 3000;  
const long intervalW = 3000;  


void setup()
{
  Serial.begin(115200);   //Apro la comunicazione seriale
 
  emon1.current(1, 17.5);             // Current: input pin, calibration.

  dht.begin();
  delay(100);

}

void loop()
{
  if ((millis() - timestampW) > intervalW) {
    timestampW = millis();
    double Irms = emon1.calcIrms(1480);  // Calculate Irms only
    int Watt = Irms*rede;
    String Values; 
    Values += F("W");
    Values += String(Watt);
    Values += F("T");
    Values += temp_send;
    Values += F("H");
    Values += hum_send;
    Serial.println(Values); 
    
  }

  if ((millis() - timestampD) > intervalDHT) {
    // save the last time you updated the DHT values
    timestampD = millis();
    // Read temperature as Celsius (the default) and Humidity
    float temp = dht.readTemperature();
    float hum = dht.readHumidity();
    Serial.println(temp);
    Serial.println(hum);
    String(temp).toCharArray(temp_send, 5);
    String(hum).toCharArray(hum_send, 5);
            
  }
         
}
